<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mechoori.web.repository.RestaurantRepository">
	<select id="findById" resultType="Restaurant">
		select *
		from restaurant
		where id = #{restaurantId}
	</select>

	<select id="findAll" resultType="Restaurant">
		select *
		from restaurant
		<trim prefix="where" prefixOverrides="AND|OR">
			<if test="categoryId != null">
				category_id = #{categoryId};
			</if>
			<if test="query != null">
				name like '%${query}%'
			</if>
		</trim>
		<if test="page != null">
			limit #{page}, #{size}
		</if>
	</select>

	<select id="findAllRestaurantView" resultType="RestaurantView">
		select distinct restaurant_card.*
		from restaurant_card
		left join menu on restaurant_card.id = menu.restaurant_id
		<trim prefix="where" prefixOverrides="AND|OR">
			<if test="categoryId != null">
				category_id = #{categoryId}
			</if>
			<if test="query != null">
				restaurant_card.name like '%${query}%' or menu.name like '%${query}%'
			</if>
		</trim>
	</select>

	<select id="findAllRestaurantView" resultType="RestaurantView">
		SELECT r.*,
		IF(rl.restaurant_id IS NOT NULL, 1, 0) AS `like`,
		IFNULL(rt.rate_count, 0) AS `rate`
		FROM restaurant_view r
		LEFT JOIN (
		SELECT DISTINCT restaurant_id
		FROM restaurant_like
		WHERE member_id = 1
		) rl ON r.id = rl.restaurant_id
		LEFT JOIN (
		SELECT menu.restaurant_id, COUNT(rate.member_id) AS rate_count
		FROM menu
		LEFT JOIN rate ON menu.id = rate.menu_id AND rate.member_id = 1
		GROUP BY menu.restaurant_id
		) rt ON r.id = rt.restaurant_id;
	</select>

	<select id="getRanking" resultType="RestaurantView">
		SELECT *
		from restaurant_card
		where category_id = ${categoryId}
		ORDER BY avg_rated_price DESC;
	</select>


	<select id="findAllRestaurant" resultType="Restaurant">
		select * from restaurant
	</select>




</mapper>